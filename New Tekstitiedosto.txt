import sys
import sqlite3, webbrowser, csv
from datetime import datetime
from tkinter import Tk, StringVar, BooleanVar, ttk, messagebox, filedialog, Toplevel
import tkinter.font as tkfont

import os, sys
def resource_path(rel_path: str) -> str:
    # Works for PyInstaller --onefile and normal run
    if getattr(sys, "frozen", False) and hasattr(sys, "_MEIPASS"):
        return os.path.join(sys._MEIPASS, rel_path)
    return os.path.join(os.path.abspath("."), rel_path)
from pathlib import Path

def app_data_dir():
    # When packaged as .exe, save under %APPDATA%\JobTracker
    if getattr(sys, "frozen", False):
        base = Path(os.getenv("APPDATA")) / "JobTracker"
    else:
        base = Path.cwd()
    base.mkdir(parents=True, exist_ok=True)
    return base

DB_PATH = str(app_data_dir() / "applications.db")

# --- statuses ---
STATUSES = ["Applied", "Replied", "Interview", "Offer", "Denied", "Ghosted"]


from tkinter import PhotoImage  # (you already import ttk; this adds PhotoImage)

STATUS_COLORS = {
    "Applied":  "#3b82f6",   # blue
    "Replied":  "#a855f7",   # purple
    "Interview":"#facc15",   # yellow
    "Offer":    "#22c55e",   # green
    "Denied":   "#ef4444",   # red
    "Ghosted":  "#9ca3af",   # gray
}

def make_square_icon(color: str, size: int = 10) -> PhotoImage:
    img = PhotoImage(width=size, height=size)
    img.put(color, to=(0, 0, size, size))
    return img
# ---------- DB ----------
def init_db():
    con = sqlite3.connect(DB_PATH)
    cur = con.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS applications (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            company TEXT NOT NULL,
            title   TEXT NOT NULL,
            date_applied TEXT,               -- now optional
            link    TEXT,
            status  TEXT DEFAULT 'Applied'
        )
    """)
    # Add status column if old DB
    cur.execute("PRAGMA table_info(applications)")
    cols = [r[1] for r in cur.fetchall()]
    if "status" not in cols:
        cur.execute("ALTER TABLE applications ADD COLUMN status TEXT DEFAULT 'Applied'")
        cur.execute("UPDATE applications SET status = 'Applied' WHERE status IS NULL")

    # Status history table
    cur.execute("""
        CREATE TABLE IF NOT EXISTS status_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            app_id INTEGER NOT NULL,
            status TEXT NOT NULL,
            created_at TEXT NOT NULL,
            FOREIGN KEY(app_id) REFERENCES applications(id) ON DELETE CASCADE
        )
    """)
    con.commit(); con.close()

def insert(company, title, date_applied, link, status):
    con = sqlite3.connect(DB_PATH); cur = con.cursor()
    cur.execute(
        """INSERT INTO applications (company, title, date_applied, link, status)
           VALUES (?, ?, ?, ?, ?)""",
        (company, title, date_applied, link or None, status)
    )
    new_id = cur.lastrowid
    _log_status_cur(cur, new_id, status)  # log initial status
    con.commit(); con.close()
    return new_id

def delete_ids(ids):
    if not ids: return
    con = sqlite3.connect(DB_PATH); cur = con.cursor()
    cur.executemany("DELETE FROM applications WHERE id = ?", [(i,) for i in ids])
    con.commit(); con.close()

def update_status(ids, status):
    if not ids: return
    now = datetime.now().isoformat(timespec="seconds")
    con = sqlite3.connect(DB_PATH); cur = con.cursor()
    cur.executemany("UPDATE applications SET status = ? WHERE id = ?", [(status, i) for i in ids])
    # log history
    cur.executemany(
        "INSERT INTO status_log (app_id, status, created_at) VALUES (?, ?, ?)",
        [(i, status, now) for i in ids]
    )
    con.commit(); con.close()

def add_status_only(ids, status):
    """Append to history without changing the current status column."""
    if not ids: return
    now = datetime.now().isoformat(timespec="seconds")
    con = sqlite3.connect(DB_PATH); cur = con.cursor()
    cur.executemany(
        "INSERT INTO status_log (app_id, status, created_at) VALUES (?, ?, ?)",
        [(i, status, now) for i in ids]
    )
    con.commit(); con.close()

def _log_status_cur(cur, app_id, status):
    cur.execute(
        "INSERT INTO status_log (app_id, status, created_at) VALUES (?, ?, ?)",
        (app_id, status, datetime.now().isoformat(timespec="seconds"))
    )

def fetch_all():
    """Return rows with interview count joined in."""
    con = sqlite3.connect(DB_PATH); cur = con.cursor()
    cur.execute("""
        SELECT
            a.id, a.company, a.title, a.date_applied, a.link, a.status,
            COALESCE((
                SELECT COUNT(*) FROM status_log sl
                WHERE sl.app_id = a.id AND sl.status = 'Interview'
            ), 0) AS interview_count
        FROM applications a
        ORDER BY a.date_applied DESC NULLS LAST, a.id DESC
    """)
    rows = cur.fetchall()
    con.close()
    return rows

def fetch_history(app_id):
    con = sqlite3.connect(DB_PATH); cur = con.cursor()
    cur.execute("""
        SELECT status, created_at
        FROM status_log
        WHERE app_id = ?
        ORDER BY created_at ASC, id ASC
    """, (app_id,))
    rows = cur.fetchall()
    con.close()
    return rows

# ---------- UI helpers ----------
def configure_style(dark: bool):
    global colors
    style = ttk.Style()
    style.theme_use("clam")

    if dark:
        bg = "#121417"; surface = "#171A1E"; card = "#1D2126"
        fg = "#E6E8EB"; sub = "#AAB2BD"; stroke = "#2A2F36"
        accent = "#6EA8FE"; accent_hover = "#90BEFF"; danger = "#FF6B6B"
    else:
        bg = "#F6F7F9"; surface = "#FFFFFF"; card = "#FFFFFF"
        fg = "#1B1F24"; sub = "#5B6573"; stroke = "#E7EAF0"
        accent = "#2563EB"; accent_hover = "#3B82F6"; danger = "#E53935"

    root.configure(bg=bg)
    style.configure("TFrame", background=bg)
    style.configure("Surface.TFrame", background=surface)
    style.configure("Card.TFrame", background=card, borderwidth=1, relief="solid")

    style.configure("TLabel", background=bg, foreground=fg, font=("Segoe UI", 10))
    style.configure("Subtle.TLabel", background=bg, foreground=sub, font=("Segoe UI", 10))
    style.configure("Header.TLabel", background=bg, foreground=fg, font=("Segoe UI Semibold", 14))

    style.configure("TEntry", fieldbackground=surface, foreground=fg, bordercolor=stroke, lightcolor=accent)
    style.map("TEntry", bordercolor=[("focus", accent)])

    style.configure("TButton", font=("Segoe UI Semibold", 10), padding=8)
    style.configure("Accent.TButton", background=accent, foreground="white", borderwidth=0)
    style.map("Accent.TButton", background=[("active", accent_hover)])
    style.configure("Danger.TButton", background=danger, foreground="white", borderwidth=0)
    style.map("Danger.TButton", background=[("active", danger)])
    style.configure("Ghost.TButton", background=bg, foreground=fg, borderwidth=0)

    # Treeview fonts
    tv_font = tkfont.Font(root, family="Segoe UI", size=10)
    tv_head_font = tkfont.Font(root, family="Segoe UI", size=10, weight="bold")

    style.configure(
        "Treeview",
        background=card,
        fieldbackground=card,
        foreground=fg,
        bordercolor=stroke,
        rowheight=28,
        font=tv_font
    )
    style.configure(
        "Treeview.Heading",
        background=surface,
        foreground=fg,
        font=tv_head_font,
        bordercolor=stroke
    )

    style.configure("TSeparator", background=stroke)

    colors.update(dict(bg=bg, surface=surface, card=card, fg=fg, sub=sub, stroke=stroke, accent=accent))

def zebra_table(tree):
    tree.tag_configure("odd", background=blend(colors["card"], colors["stroke"], 0.12))

def blend(c1, c2, alpha):
    def to_rgb(c): return tuple(int(c[i:i+2], 16) for i in (1,3,5))
    def to_hex(t): return "#%02x%02x%02x" % t
    a = to_rgb(c1); b = to_rgb(c2)
    mix = tuple(int((1-alpha)*a[i] + alpha*b[i]) for i in range(3))
    return to_hex(mix)

def format_date(d):
    return d if d else "â€”"

def renumber_rows():
    """Set the 'No' column to 1..n in the current visual order."""
    for i, item in enumerate(table.get_children(""), start=1):
        table.set(item, "No", str(i))

def load_records():
    """Populate table without showing DB id. Store id in item's iid."""
    for r in table.get_children():
        table.delete(r)
    rows = fetch_all()
    for idx, r in enumerate(rows, start=1):
        # r = (id, company, title, date, link, status, interviews)
        tag = "odd" if (idx - 1) % 2 else ""
        table.insert(
            "", "end",
            iid=str(r[0]),  # keep DB id internally
            values=(idx, r[1], r[2], format_date(r[3]), r[4] if r[4] else "None", r[5], r[6]),
            tags=(tag,)
        )
    renumber_rows()
    count_var.set(f"{len(rows)} saved")

def clear_form():
    company_var.set(""); title_var.set("")
    date_var.set(datetime.now().strftime("%Y-%m-%d"))  # prefill; you can delete it
    link_var.set("")
    status_var.set("Applied")

def save_record():
    c = company_var.get().strip()
    t = title_var.get().strip()
    d = date_var.get().strip()
    l = link_var.get().strip()
    s = status_var.get().strip() or "Applied"

    if not c or not t:
        messagebox.showerror("Missing data", "Company and Job Title are required.")
        return

    # Date optional: validate only if provided
    if d:
        try:
            datetime.strptime(d, "%Y-%m-%d")
        except ValueError:
            messagebox.showerror("Bad date", "Use YYYY-MM-DD (e.g., 2025-09-16), or leave empty.")
            return
    else:
        d = None  # store NULL

    insert(c, t, d, l, s)
    clear_form(); load_records()
    toast("Saved âœ…")

def _selected_ids():
    sel = table.selection()
    if not sel:
        return []
    return [int(i) for i in sel]

def delete_selected():
    ids = _selected_ids()
    if not ids:
        messagebox.showwarning("No selection", "Select one or more rows to delete.")
        return
    if not messagebox.askyesno("Confirm", "Delete selected record(s)?"):
        return
    delete_ids(ids); load_records()
    toast("Deleted ðŸ—‘ï¸")

def set_status_from_quick(status):
    ids = _selected_ids()
    if not ids:
        messagebox.showinfo("Status", "Select one or more rows.")
        return
    update_status(ids, status)
    load_records()
    toast(f"Status â†’ {status}")

def add_status_dialog():
    ids = _selected_ids()
    if not ids:
        messagebox.showinfo("Status", "Select one or more rows first.")
        return

    win = Toplevel(root)
    win.title("Add Status (history only)")
    win.transient(root); win.grab_set()
    frm = ttk.Frame(win, padding=12); frm.grid()
    ttk.Label(frm, text="Choose a status to append to the history (wonâ€™t change current status):").grid(row=0, column=0, columnspan=2, sticky="w", pady=(0,8))

    sel_var = StringVar(value=STATUSES[0])
    cb = ttk.Combobox(frm, textvariable=sel_var, values=STATUSES, state="readonly", width=20)
    cb.grid(row=1, column=0, sticky="w")

    def do_add():
        s = sel_var.get()
        add_status_only(ids, s)
        load_records()
        toast(f"Added to history â†’ {s}")
        win.destroy()

    ttk.Button(frm, text="Add", style="Accent.TButton", command=do_add).grid(row=1, column=1, padx=8)
    ttk.Button(frm, text="Cancel", command=win.destroy).grid(row=1, column=2)

def view_history():
    ids = _selected_ids()
    if len(ids) != 1:
        messagebox.showinfo("History", "Select exactly one row to view its history.")
        return
    app_id = ids[0]
    hist = fetch_history(app_id)

    win = Toplevel(root)
    win.title("Status History")
    win.transient(root); win.grab_set()
    frm = ttk.Frame(win, padding=12); frm.grid(sticky="nsew")
    win.columnconfigure(0, weight=1); win.rowconfigure(0, weight=1)

    tv = ttk.Treeview(frm, columns=("When", "Status"), show="headings", height=12)
    tv.heading("When", text="When")
    tv.heading("Status", text="Status")
    tv.column("When", width=160, anchor="w")
    tv.column("Status", width=140, anchor="w")
    tv.grid(row=0, column=0, sticky="nsew")

    vsb = ttk.Scrollbar(frm, orient="vertical", command=tv.yview)
    tv.configure(yscrollcommand=vsb.set)
    vsb.grid(row=0, column=1, sticky="ns")

    for s, ts in hist:
        tv.insert("", "end", values=(ts, s))

def export_csv():
    path = filedialog.asksaveasfilename(
        defaultextension=".csv",
        filetypes=[("CSV files", "*.csv")],
        initialfile="applications.csv",
        title="Export to CSV"
    )
    if not path: return
    rows = fetch_all()
    with open(path, "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["Company", "Job Title", "Date", "Link", "Status", "Interviews"])
        for r in rows:
            writer.writerow([r[1], r[2], r[3] or "", r[4] or "", r[5], r[6]])
    toast("Exported to CSV ðŸ“„")

def open_link():
    sel = table.selection()
    if not sel:
        messagebox.showinfo("Open link", "Select a row first.")
        return
    link = table.set(sel[0], "Link")
    if not link or link == "None":
        messagebox.showinfo("Open link", "Selected row has no link.")
        return
    webbrowser.open(link)

def copy_row():
    sel = table.selection()
    if not sel: return
    vals = [table.set(sel[0], col) for col in ("Company", "Job Title", "Date", "Link", "Status", "Interviews")]
    root.clipboard_clear()
    root.clipboard_append("\t".join(map(str, vals)))
    toast("Copied ðŸ“‹")

def on_double_click(event):
    item = table.identify_row(event.y)
    if not item: return
    col_index = int(table.identify_column(event.x)[1:])  # "#1" -> 1
    cols_order = ("No", "Company", "Job Title", "Date", "Link", "Status", "Interviews")
    if 1 <= col_index <= len(cols_order) and cols_order[col_index - 1] == "Link":
        link = table.set(item, "Link")
        if link and link != "None":
            webbrowser.open(link)

def sort_by(col_id, reverse=False):
    data = [(table.set(k, col_id), k) for k in table.get_children("")]
    if col_id in ("No", "Interviews"):
        def key_fn(x):
            try: return int(x[0])
            except: return -10**9
        data.sort(key=key_fn, reverse=reverse)
    else:
        data.sort(reverse=reverse)
    for idx, (val, k) in enumerate(data):
        table.move(k, "", idx)
        table.item(k, tags=("odd",) if idx % 2 else ())
    renumber_rows()
    table.heading(col_id, command=lambda: sort_by(col_id, not reverse))

def toast(msg):
    status_msg_var.set(msg)
    root.after(2200, lambda: status_msg_var.set(""))

# ---------- App ----------
root = Tk()
root.title("JobApplicationTracker3000")
try:
    root.iconbitmap(resource_path("app.ico"))
except Exception as e:
    print("Icon load failed:", e)
# Wider/taller defaults AND narrower columns so it fits
root.geometry("1122x700")
root.minsize(940, 600)

colors = {}
dark_mode = BooleanVar(value=True)
count_var = StringVar(value="")
status_msg_var = StringVar(value="")

company_var = StringVar()
title_var = StringVar()
date_var = StringVar(value=datetime.now().strftime("%Y-%m-%d"))  # optional; you can clear it
link_var = StringVar()
status_var = StringVar(value="Applied")

configure_style(dark_mode.get())

# Top bar
top = ttk.Frame(root, style="TFrame", padding=(16, 16, 16, 8)); top.grid(row=0, column=0, sticky="ew")
title_lbl = ttk.Label(top, text="Current Employment Tracking", style="Header.TLabel")
title_lbl.grid(row=0, column=0, sticky="w")
ttk.Label(top, textvariable=count_var, style="Subtle.TLabel").grid(row=0, column=1, sticky="w", padx=(12,0))

spacer = ttk.Frame(top); spacer.grid(row=0, column=2, sticky="ew"); top.columnconfigure(2, weight=1)
def toggle_theme():
    configure_style(dark_mode.get()); zebra_table(table)
ttk.Checkbutton(top, text="Dark mode", variable=dark_mode, command=toggle_theme).grid(row=0, column=3, sticky="e")

# Form card
card = ttk.Frame(root, style="Card.TFrame", padding=16); card.grid(row=1, column=0, sticky="ew", padx=16)
for i in range(7): card.columnconfigure(i, weight=1)

ttk.Label(card, text="Company *").grid(row=0, column=0, sticky="w", padx=(0,8), pady=(0,6))
ttk.Entry(card, textvariable=company_var).grid(row=1, column=0, sticky="ew", padx=(0,12), pady=(0,8))

ttk.Label(card, text="Job Title *").grid(row=0, column=1, sticky="w", padx=(0,8), pady=(0,6))
ttk.Entry(card, textvariable=title_var).grid(row=1, column=1, sticky="ew", padx=(0,12), pady=(0,8))

ttk.Label(card, text="Date (YYYY-MM-DD)").grid(row=0, column=2, sticky="w", padx=(0,8), pady=(0,6))  # no *
ttk.Entry(card, textvariable=date_var).grid(row=1, column=2, sticky="ew", padx=(0,12), pady=(0,8))

ttk.Label(card, text="Link").grid(row=0, column=3, sticky="w", padx=(0,8), pady=(0,6))
ttk.Entry(card, textvariable=link_var).grid(row=1, column=3, sticky="ew", padx=(0,0), pady=(0,8))

ttk.Label(card, text="Status").grid(row=0, column=4, sticky="w", padx=(0,8), pady=(0,6))
ttk.Combobox(card, textvariable=status_var, values=STATUSES, state="readonly").grid(row=1, column=4, sticky="ew")

btns = ttk.Frame(card, style="Surface.TFrame"); btns.grid(row=2, column=0, columnspan=7, sticky="w", pady=(8,0))
ttk.Button(btns, text="Save", style="Accent.TButton", command=save_record).grid(row=0, column=0, padx=(0,8))
ttk.Button(btns, text="Clear", style="Ghost.TButton", command=clear_form).grid(row=0, column=1, padx=(0,8))
ttk.Button(btns, text="Delete Selected", style="Danger.TButton", command=delete_selected).grid(row=0, column=2, padx=(0,8))
ttk.Button(btns, text="Export CSV", style="TButton", command=export_csv).grid(row=0, column=3, padx=(0,8))
ttk.Button(btns, text="Open Link", style="TButton", command=open_link).grid(row=0, column=4, padx=(0,8))
ttk.Button(btns, text="Add Statusâ€¦", style="TButton", command=add_status_dialog).grid(row=0, column=5, padx=(0,8))
ttk.Button(btns, text="View History", style="TButton", command=view_history).grid(row=0, column=6, padx=(0,8))

# Quick status row (neutral chips with colored square icon per status)
qs = ttk.Frame(card, style="Surface.TFrame")
qs.grid(row=3, column=0, columnspan=7, sticky="w", pady=(8,0))
ttk.Label(qs, text="Quick status for selected:", style="Subtle.TLabel").grid(row=0, column=0, padx=(0,8))

style = ttk.Style()
style.configure(
    "Chip.TButton",
    background=colors["surface"],
    foreground=colors["fg"],
    padding=(10, 6),
    borderwidth=1
)
style.map("Chip.TButton", background=[("active", colors["surface"])])

# build colored icons once and KEEP REFERENCES so they don't get garbage-collected
quick_icons = {st: make_square_icon(STATUS_COLORS[st], 10) for st in STATUSES}

for i, st in enumerate(STATUSES, start=1):
    ttk.Button(
        qs,
        text=f"  {st}",                    # space for breathing room after the icon
        image=quick_icons[st],             # colored cue
        compound="left",                   # show icon to the left of text
        style="Chip.TButton",
        command=lambda s=st: set_status_from_quick(s)
    ).grid(row=0, column=i, padx=4)

# Table area (narrower columns to fit)
table_wrap = ttk.Frame(root, style="TFrame", padding=(16, 8, 16, 12))
table_wrap.grid(row=2, column=0, sticky="nsew")
root.rowconfigure(2, weight=1); root.columnconfigure(0, weight=1)

cols = ("No", "Company", "Job Title", "Date", "Link", "Status", "Interviews")
table = ttk.Treeview(table_wrap, columns=cols, show="headings", height=16, selectmode="extended")
widths = (46, 210, 240, 120, 250, 110, 96)   # tighter widths so everything fits ~1180
for c, w in zip(cols, widths):
    table.heading(c, text=c, command=(lambda col=c: sort_by(col, False)))
    anchor = "center" if c in ("No", "Interviews") else "w"
    table.column(c, width=w, anchor=anchor, stretch=False)
table.grid(row=0, column=0, sticky="nsew")

total_width = sum(widths) + 60   # +60 for scrollbar + padding
root.geometry(f"{total_width}x700")
root.minsize(total_width, 600)

vsb = ttk.Scrollbar(table_wrap, orient="vertical", command=table.yview)
hsb = ttk.Scrollbar(table_wrap, orient="horizontal", command=table.xview)
table.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
vsb.grid(row=0, column=1, sticky="ns")
hsb.grid(row=1, column=0, sticky="ew")
table_wrap.rowconfigure(0, weight=1); table_wrap.columnconfigure(0, weight=1)

table.bind("<Double-1>", on_double_click)
zebra_table(table)

# Status bar
sep = ttk.Separator(root); sep.grid(row=3, column=0, sticky="ew")
status = ttk.Frame(root, padding=(16, 6))
status.grid(row=4, column=0, sticky="ew")
ttk.Label(status, textvariable=status_msg_var, style="Subtle.TLabel").grid(row=0, column=0, sticky="w")

# Keyboard shortcuts
root.bind("<Control-s>", lambda e: save_record())
root.bind("<Control-S>", lambda e: save_record())
root.bind("<Control-BackSpace>", lambda e: delete_selected())
root.bind("<Control-c>", lambda e: copy_row())

# Init
init_db()
load_records()
toast("Ready âœ¨")

root.mainloop()
